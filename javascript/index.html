<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>GO2 Robot Controller</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2/dist/coco-ssd.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }
      
      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        background: #000;
        color: #fff;
        height: 100vh;
        overflow: hidden;
        position: relative;
      }
      
      /* Video Background */
      .video-background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 1;
      }
      
      #video-frame {
        width: 100%;
        height: 100%;
        object-fit: cover;
        background: #000;
      }
      
      /* YOLO Detection Canvas */
      #detection-canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 2;
      }
      
      .detection-toggle {
        position: absolute;
        top: 80px;
        right: 20px;
        background: rgba(255,255,255,0.1);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 25px;
        padding: 8px 16px;
        color: #fff;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      
      .detection-toggle.active {
        background: rgba(0,122,255,0.3);
        border-color: rgba(0,122,255,0.5);
      }
      
      /* UI Overlay */
      .ui-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 10;
        pointer-events: none;
      }
      
      .ui-overlay > * {
        pointer-events: auto;
      }
      
      /* Top Bar */
      .top-bar {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, transparent 100%);
        backdrop-filter: blur(20px);
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      .status-badge {
        display: flex;
        align-items: center;
        gap: 10px;
        background: rgba(255,255,255,0.1);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 50px;
        padding: 12px 20px;
        font-size: 14px;
        font-weight: 600;
      }
      
      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #ff3b30;
        animation: pulse 2s infinite;
      }
      
      .status-dot.connected {
        background: #30d158;
      }
      
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
      }
      
      .settings-btn {
        background: rgba(255,255,255,0.1);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 50%;
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 18px;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      
      .settings-btn:hover {
        background: rgba(255,255,255,0.2);
      }
      
      /* Control Panels */
      .control-panel {
        position: absolute;
        background: rgba(0,0,0,0.8);
        backdrop-filter: blur(30px);
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      }
      
      /* Movement Controls */
      .movement-panel {
        bottom: 20px;
        left: 20px;
        width: 180px;
        height: 180px;
      }
      
      .movement-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-template-rows: repeat(3, 1fr);
        gap: 8px;
        width: 100%;
        height: 100%;
      }
      
      .move-btn {
        background: rgba(255,255,255,0.1);
        backdrop-filter: blur(15px);
        border: 1px solid rgba(255,255,255,0.3);
        border-radius: 12px;
        color: #fff;
        font-size: 18px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        user-select: none;
        font-weight: 600;
      }
      
      .move-btn:active {
        background: rgba(0,122,255,0.5);
        transform: scale(0.95);
      }
      
      .move-btn.stop {
        background: rgba(255,59,48,0.5);
        border-color: rgba(255,59,48,0.7);
      }
      
      /* Action Commands */
      .actions-panel {
        bottom: 20px;
        right: 20px;
        width: 280px;
        max-height: 300px;
      }
      
      .actions-title {
        font-size: 16px;
        font-weight: 700;
        margin-bottom: 16px;
        text-align: center;
      }
      
      .actions-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        max-height: 200px;
        overflow-y: auto;
      }
      
      .action-btn {
        background: rgba(255,255,255,0.1);
        backdrop-filter: blur(15px);
        border: 1px solid rgba(255,255,255,0.3);
        border-radius: 12px;
        color: #fff;
        padding: 12px 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
        font-size: 11px;
        font-weight: 600;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        min-height: 60px;
      }
      
      .action-btn:active {
        background: rgba(0,122,255,0.5);
        transform: scale(0.95);
      }
      
      .action-icon {
        font-size: 20px;
      }
      
      /* Settings Panel */
      .settings-panel {
        position: fixed;
        top: 0;
        right: -400px;
        width: 400px;
        height: 100vh;
        background: rgba(0,0,0,0.95);
        backdrop-filter: blur(30px);
        border-left: 1px solid rgba(255,255,255,0.2);
        z-index: 100;
        transition: right 0.3s ease;
        overflow-y: auto;
        padding: 30px;
      }
      
      .settings-panel.open {
        right: 0;
      }
      
      .settings-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid rgba(255,255,255,0.2);
      }
      
      .settings-title {
        font-size: 24px;
        font-weight: 700;
      }
      
      .close-btn {
        background: none;
        border: none;
        color: #fff;
        font-size: 24px;
        cursor: pointer;
        padding: 8px;
      }
      
      .form-group {
        margin-bottom: 20px;
      }
      
      .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        font-size: 14px;
      }
      
      .form-input, .form-select {
        width: 100%;
        padding: 16px;
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 12px;
        color: #fff;
        font-size: 16px;
      }
      
      .form-input:focus, .form-select:focus {
        outline: none;
        border-color: #007AFF;
        box-shadow: 0 0 0 3px rgba(0,122,255,0.2);
      }
      
      .btn {
        background: linear-gradient(135deg, #007AFF 0%, #0056b3 100%);
        color: #fff;
        border: none;
        padding: 16px 24px;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 100%;
      }
      
      .btn:hover {
        transform: translateY(-2px);
      }
      
      .log {
        background: rgba(0,0,0,0.8);
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 12px;
        padding: 16px;
        margin-top: 20px;
        max-height: 200px;
        overflow-y: auto;
        font-family: 'SF Mono', Monaco, monospace;
        font-size: 12px;
      }
      
      .log-code {
        color: #30d158;
        white-space: pre-wrap;
      }
      
      /* Mobile Responsive */
      @media (max-width: 768px) {
        .movement-panel {
          width: calc(50vw - 30px);
          height: 160px;
          bottom: 15px;
          left: 15px;
        }
        
        .actions-panel {
          width: calc(50vw - 30px);
          bottom: 15px;
          right: 15px;
        }
        
        .actions-grid {
          grid-template-columns: repeat(2, 1fr);
        }
        
        .top-bar {
          padding: 15px;
        }
        
        .settings-content {
          margin: 20px auto;
          padding: 24px;
        }
      }
    </style>

    <script src="md5.js"></script>
    <script src="joy.min.js"></script>
  </head>
  <body>
    <!-- Video Background -->
    <div class="video-background">
      <video id="video-frame" autoplay playsinline muted></video>
      <canvas id="detection-canvas"></canvas>
    </div>

    <!-- UI Overlay -->
    <div class="ui-overlay">
      <!-- Top Bar -->
      <div class="top-bar">
        <div class="status-badge">
          <div class="status-dot" id="status-dot"></div>
          <span id="status-text">Disconnected</span>
        </div>
        <button class="settings-btn" id="settings-toggle">‚öôÔ∏è</button>
      </div>
      
      <!-- YOLO Toggle -->
      <button class="detection-toggle" id="yolo-toggle">üéØ YOLO OFF</button>

      <!-- Movement Controls -->
      <div class="control-panel movement-panel">
        <div class="movement-grid">
          <button class="move-btn" onmousedown="startMove('turn-left')" onmouseup="stopMove()" ontouchstart="startMove('turn-left')" ontouchend="stopMove()">‚Ü∫</button>
          <button class="move-btn" onmousedown="startMove('forward')" onmouseup="stopMove()" ontouchstart="startMove('forward')" ontouchend="stopMove()">‚Üë</button>
          <button class="move-btn" onmousedown="startMove('turn-right')" onmouseup="stopMove()" ontouchstart="startMove('turn-right')" ontouchend="stopMove()">‚Üª</button>
          <button class="move-btn" onmousedown="startMove('left')" onmouseup="stopMove()" ontouchstart="startMove('left')" ontouchend="stopMove()">‚Üê</button>
          <button class="move-btn stop" onclick="stopMove()">‚èπ</button>
          <button class="move-btn" onmousedown="startMove('right')" onmouseup="stopMove()" ontouchstart="startMove('right')" ontouchend="stopMove()">‚Üí</button>
          <button class="move-btn"></button>
          <button class="move-btn" onmousedown="startMove('backward')" onmouseup="stopMove()" ontouchstart="startMove('backward')" ontouchend="stopMove()">‚Üì</button>
          <button class="move-btn"></button>
        </div>
      </div>

      <!-- Action Commands -->
      <div class="control-panel actions-panel">
        <h3 class="actions-title">Commands</h3>
        <div class="actions-grid">
          <button class="action-btn" onclick="quickCommand(1004)">
            <div class="action-icon">üêï</div>
            <div>Stand</div>
          </button>
          <button class="action-btn" onclick="quickCommand(1009)">
            <div class="action-icon">üí∫</div>
            <div>Sit</div>
          </button>
          <button class="action-btn" onclick="quickCommand(1016)">
            <div class="action-icon">üëã</div>
            <div>Hello</div>
          </button>
          <button class="action-btn" onclick="quickCommand(1022)">
            <div class="action-icon">üíÉ</div>
            <div>Dance</div>
          </button>
          <button class="action-btn" onclick="quickCommand(1017)">
            <div class="action-icon">ü§∏</div>
            <div>Stretch</div>
          </button>
          <button class="action-btn" onclick="quickCommand(1030)">
            <div class="action-icon">ü§∏‚Äç‚ôÇÔ∏è</div>
            <div>Flip</div>
          </button>
        </div>
      </div>
    </div>

    <!-- Settings Panel -->
    <div class="settings-panel" id="settings-panel">
      <div class="settings-header">
        <h2 class="settings-title">Settings</h2>
        <button class="close-btn" id="settings-close">‚úï</button>
      </div>

      <div class="form-group">
        <label class="form-label" for="robot-ip">Robot IP Address</label>
        <input type="text" id="robot-ip" class="form-input" placeholder="192.168.1.xxx">
      </div>

      <div class="form-group">
        <label class="form-label" for="token">Security Token (Optional)</label>
        <input type="text" id="token" class="form-input" placeholder="Enter security token...">
      </div>

      <div class="form-group">
        <label class="form-label" for="command">Quick Commands</label>
        <select id="command" class="form-select"></select>
        <button id="execute-btn" class="btn" style="margin-top: 10px;">Execute Selected</button>
      </div>

      <div class="form-group">
        <label class="form-label" for="gamepad">Controller</label>
        <select id="gamepad" class="form-select"></select>
      </div>

      <button id="connect-btn" class="btn">Connect to Robot</button>

      <div class="form-group" style="margin-top: 20px;">
        <label class="form-label" for="custom-command">Custom Command</label>
        <div style="display: flex; gap: 10px;">
          <input type="text" id="custom-command" class="form-input" placeholder="Enter custom command..." style="flex: 1;">
          <button id="execute-custom-btn" class="btn" style="margin: 0; width: auto; padding: 16px 20px;">Send</button>
        </div>
      </div>

      <div class="log" id="log">
        <code class="log-code" id="log-code">Ready to connect...</code>
      </div>
    </div>

    <script>
      // Global UI functions - removed toggleSettings

      function updateConnectionStatus(connected) {
        const dot = document.getElementById('status-dot');
        const text = document.getElementById('status-text');
        
        if (connected) {
          dot.classList.add('connected');
          text.textContent = 'Connected';
        } else {
          dot.classList.remove('connected');
          text.textContent = 'Disconnected';
        }
      }

      function quickCommand(cmdId) {
        if(globalThis.rtc !== undefined) {
          const uniqID = (new Date().valueOf() % 2147483648) + Math.floor(Math.random() * 1e3);
          globalThis.rtc.publish("rt/api/sport/request", {
            header: { identity: { id: uniqID, api_id: cmdId } },
            parameter: JSON.stringify(cmdId),
          });
          
          if (navigator.vibrate) navigator.vibrate(50);
        } else {
          logMessage("‚ùå Please connect to robot first");
        }
      }

      let moveInterval = null;
      let yoloModel = null;
      let yoloEnabled = false;
      let detectionInterval = null;
      
      // Load YOLO model
      async function loadYOLO() {
        try {
          yoloModel = await cocoSsd.load();
          console.log('YOLO model loaded');
        } catch (error) {
          console.error('Failed to load YOLO model:', error);
        }
      }
      
      // Draw detection boxes
      function drawDetections(predictions, canvas, video) {
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        predictions.forEach(prediction => {
          const [x, y, width, height] = prediction.bbox;
          const confidence = prediction.score.toFixed(2);
          const label = prediction.class;
          
          // Draw bounding box
          ctx.strokeStyle = '#00ff00';
          ctx.lineWidth = 2;
          ctx.strokeRect(x, y, width, height);
          
          // Draw label background
          ctx.fillStyle = 'rgba(0, 255, 0, 0.8)';
          ctx.fillRect(x, y - 25, ctx.measureText(`${label} ${confidence}`).width + 10, 25);
          
          // Draw label text
          ctx.fillStyle = '#000';
          ctx.font = '14px Inter';
          ctx.fillText(`${label} ${confidence}`, x + 5, y - 8);
        });
      }
      
      // Run YOLO detection
      async function runDetection() {
        if (!yoloModel || !yoloEnabled) return;
        
        const video = document.getElementById('video-frame');
        const canvas = document.getElementById('detection-canvas');
        
        if (video.videoWidth === 0 || video.videoHeight === 0) return;
        
        // Resize canvas to match video
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        try {
          const predictions = await yoloModel.detect(video);
          drawDetections(predictions, canvas, video);
        } catch (error) {
          console.error('Detection error:', error);
        }
      }
      
      // Toggle YOLO detection
      function toggleYOLO() {
        const toggle = document.getElementById('yolo-toggle');
        
        if (!yoloModel) {
          toggle.textContent = 'üéØ Loading...';
          loadYOLO().then(() => {
            if (yoloModel) {
              toggleYOLO();
            }
          });
          return;
        }
        
        yoloEnabled = !yoloEnabled;
        
        if (yoloEnabled) {
          toggle.textContent = 'üéØ YOLO ON';
          toggle.classList.add('active');
          detectionInterval = setInterval(runDetection, 200); // 5 FPS
        } else {
          toggle.textContent = 'üéØ YOLO OFF';
          toggle.classList.remove('active');
          if (detectionInterval) {
            clearInterval(detectionInterval);
            detectionInterval = null;
          }
          // Clear canvas
          const canvas = document.getElementById('detection-canvas');
          const ctx = canvas.getContext('2d');
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
      }
      
      function startMove(direction) {
        if (!globalThis.rtc) return;
        
        let x = 0, y = 0, z = 0;
        switch(direction) {
          case 'forward': x = 0.8; break;
          case 'backward': x = -0.4; break;
          case 'left': y = 0.4; break;
          case 'right': y = -0.4; break;
          case 'turn-left': z = 2; break;
          case 'turn-right': z = -2; break;
        }
        
        globalThis.rtc.publishApi("rt/api/sport/request", 1008, JSON.stringify({x, y, z}));
        
        moveInterval = setInterval(() => {
          if (globalThis.rtc) {
            globalThis.rtc.publishApi("rt/api/sport/request", 1008, JSON.stringify({x, y, z}));
          }
        }, 100);
      }
      
      function stopMove() {
        if (moveInterval) {
          clearInterval(moveInterval);
          moveInterval = null;
        }
        if (globalThis.rtc) {
          globalThis.rtc.publishApi("rt/api/sport/request", 1008, JSON.stringify({x: 0, y: 0, z: 0}));
        }
      }

      // Make functions global
      window.updateConnectionStatus = updateConnectionStatus;
      window.quickCommand = quickCommand;
      window.startMove = startMove;
      window.stopMove = stopMove;

      // Initialize
      document.addEventListener('DOMContentLoaded', function() {
        updateConnectionStatus(false);
        
        // Settings panel toggle
        const settingsToggle = document.getElementById('settings-toggle');
        const settingsPanel = document.getElementById('settings-panel');
        const settingsClose = document.getElementById('settings-close');
        const yoloToggle = document.getElementById('yolo-toggle');
        
        settingsToggle.addEventListener('click', function() {
          settingsPanel.classList.add('open');
        });
        
        settingsClose.addEventListener('click', function() {
          settingsPanel.classList.remove('open');
        });
        
        // YOLO toggle
        yoloToggle.addEventListener('click', toggleYOLO);
        
        // Load YOLO model on startup
        loadYOLO();
        
        // Close when clicking outside
        document.addEventListener('click', function(e) {
          if (settingsPanel.classList.contains('open') && 
              !settingsPanel.contains(e.target) && 
              !settingsToggle.contains(e.target)) {
            settingsPanel.classList.remove('open');
          }
        });
      });
    </script>
    <script type="module" src="index.js"></script>
  </body>
</html>