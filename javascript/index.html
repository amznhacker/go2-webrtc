<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>GO2 Robot Controller</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }
      
      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        background: #000;
        color: #fff;
        height: 100vh;
        overflow: hidden;
        position: relative;
      }
      
      /* Video Background */
      .video-background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 1;
      }
      
      #video-frame {
        width: 100%;
        height: 100%;
        object-fit: cover;
        background: #000;
      }
      
      /* UI Overlay */
      .ui-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 10;
        pointer-events: none;
      }
      
      .ui-overlay > * {
        pointer-events: auto;
      }
      
      /* Top Bar */
      .top-bar {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, transparent 100%);
        backdrop-filter: blur(20px);
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      .status-badge {
        display: flex;
        align-items: center;
        gap: 10px;
        background: rgba(255,255,255,0.1);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 50px;
        padding: 12px 20px;
        font-size: 14px;
        font-weight: 600;
      }
      
      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #ff3b30;
        animation: pulse 2s infinite;
      }
      
      .status-dot.connected {
        background: #30d158;
      }
      
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
      }
      
      .settings-btn {
        background: rgba(255,255,255,0.1);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 50%;
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 18px;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      
      .settings-btn:hover {
        background: rgba(255,255,255,0.2);
      }
      
      /* Control Panels */
      .control-panel {
        position: absolute;
        background: rgba(0,0,0,0.8);
        backdrop-filter: blur(30px);
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      }
      
      /* Movement Controls */
      .movement-panel {
        bottom: 20px;
        left: 20px;
        width: 180px;
        height: 180px;
      }
      
      .movement-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-template-rows: repeat(3, 1fr);
        gap: 8px;
        width: 100%;
        height: 100%;
      }
      
      .move-btn {
        background: rgba(255,255,255,0.1);
        backdrop-filter: blur(15px);
        border: 1px solid rgba(255,255,255,0.3);
        border-radius: 12px;
        color: #fff;
        font-size: 18px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        user-select: none;
        font-weight: 600;
      }
      
      .move-btn:active {
        background: rgba(0,122,255,0.5);
        transform: scale(0.95);
      }
      
      .move-btn.stop {
        background: rgba(255,59,48,0.5);
        border-color: rgba(255,59,48,0.7);
      }
      
      /* Action Commands */
      .actions-panel {
        bottom: 20px;
        right: 20px;
        width: 280px;
        max-height: 300px;
      }
      
      .actions-title {
        font-size: 16px;
        font-weight: 700;
        margin-bottom: 16px;
        text-align: center;
      }
      
      .actions-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        max-height: 200px;
        overflow-y: auto;
      }
      
      .action-btn {
        background: rgba(255,255,255,0.1);
        backdrop-filter: blur(15px);
        border: 1px solid rgba(255,255,255,0.3);
        border-radius: 12px;
        color: #fff;
        padding: 12px 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
        font-size: 11px;
        font-weight: 600;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        min-height: 60px;
      }
      
      .action-btn:active {
        background: rgba(0,122,255,0.5);
        transform: scale(0.95);
      }
      
      .action-icon {
        font-size: 20px;
      }
      
      /* Settings Panel */
      .settings-panel {
        position: fixed;
        top: 0;
        right: -400px;
        width: 400px;
        height: 100vh;
        background: rgba(0,0,0,0.95);
        backdrop-filter: blur(30px);
        border-left: 1px solid rgba(255,255,255,0.2);
        z-index: 100;
        transition: right 0.3s ease;
        overflow-y: auto;
        padding: 30px;
      }
      
      .settings-panel.open {
        right: 0;
      }
      
      .settings-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid rgba(255,255,255,0.2);
      }
      
      .settings-title {
        font-size: 24px;
        font-weight: 700;
      }
      
      .close-btn {
        background: none;
        border: none;
        color: #fff;
        font-size: 24px;
        cursor: pointer;
        padding: 8px;
      }
      
      .form-group {
        margin-bottom: 20px;
      }
      
      .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        font-size: 14px;
      }
      
      .form-input, .form-select {
        width: 100%;
        padding: 16px;
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 12px;
        color: #fff;
        font-size: 16px;
      }
      
      .form-input:focus, .form-select:focus {
        outline: none;
        border-color: #007AFF;
        box-shadow: 0 0 0 3px rgba(0,122,255,0.2);
      }
      
      .btn {
        background: linear-gradient(135deg, #007AFF 0%, #0056b3 100%);
        color: #fff;
        border: none;
        padding: 16px 24px;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 100%;
      }
      
      .btn:hover {
        transform: translateY(-2px);
      }
      
      .log {
        background: rgba(0,0,0,0.8);
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 12px;
        padding: 16px;
        margin-top: 20px;
        max-height: 200px;
        overflow-y: auto;
        font-family: 'SF Mono', Monaco, monospace;
        font-size: 12px;
      }
      
      .log-code {
        color: #30d158;
        white-space: pre-wrap;
      }
      
      /* All Commands Panel */
      .all-commands-panel {
        position: fixed;
        bottom: -100%;
        left: 0;
        right: 0;
        height: 60vh;
        background: rgba(0,0,0,0.95);
        backdrop-filter: blur(30px);
        border-top: 1px solid rgba(255,255,255,0.2);
        z-index: 50;
        transition: bottom 0.3s ease;
        overflow-y: auto;
        padding: 20px;
      }
      
      .all-commands-panel.open {
        bottom: 0;
      }
      
      .commands-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(255,255,255,0.2);
      }
      
      .commands-title {
        font-size: 20px;
        font-weight: 700;
      }
      
      .commands-grid {
        display: block;
        max-height: calc(60vh - 100px);
        overflow-y: auto;
      }
      
      .category-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        background: rgba(255,255,255,0.1);
        border-radius: 8px;
        margin: 8px 0 4px 0;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      
      .category-header:hover {
        background: rgba(255,255,255,0.15);
      }
      
      .category-header h3 {
        font-size: 14px;
        font-weight: 600;
        margin: 0;
      }
      
      .expand-icon {
        font-size: 12px;
        transition: transform 0.2s ease;
      }
      
      .category-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 8px;
        margin-bottom: 12px;
        padding: 0 8px;
        max-height: 500px;
        overflow: hidden;
        transition: max-height 0.3s ease;
      }
      
      .category-container.collapsed {
        max-height: 0;
        margin-bottom: 0;
      }
      
      .command-btn {
        background: rgba(255,255,255,0.1);
        backdrop-filter: blur(15px);
        border: 1px solid rgba(255,255,255,0.3);
        border-radius: 12px;
        color: #fff;
        padding: 16px 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
        font-size: 10px;
        font-weight: 600;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
        min-height: 80px;
      }
      
      .command-btn:active {
        background: rgba(0,122,255,0.5);
        transform: scale(0.95);
      }
      
      .command-icon {
        font-size: 24px;
      }
      
      .more-btn {
        background: rgba(255,255,255,0.2);
        border: 2px solid rgba(255,255,255,0.4);
        font-size: 20px;
      }
      
      /* Mobile Responsive */
      @media (max-width: 768px) {
        .top-bar {
          padding: 12px 15px;
          flex-wrap: wrap;
          gap: 8px;
        }
        
        .status-badge {
          font-size: 12px;
          padding: 8px 12px;
        }
        
        .settings-btn {
          width: 40px;
          height: 40px;
          font-size: 14px;
        }
        
        .movement-panel {
          width: calc(50vw - 20px);
          height: 140px;
          bottom: 10px;
          left: 10px;
          padding: 12px;
        }
        
        .actions-panel {
          width: calc(50vw - 20px);
          bottom: 10px;
          right: 10px;
          padding: 12px;
          max-height: 200px;
        }
        
        .actions-grid {
          grid-template-columns: repeat(2, 1fr);
          gap: 8px;
        }
        
        .action-btn {
          padding: 8px 6px;
          font-size: 10px;
          min-height: 50px;
        }
        
        .action-icon {
          font-size: 16px;
        }
        
        .actions-title {
          font-size: 14px;
          margin-bottom: 12px;
        }
        
        .move-btn {
          font-size: 14px;
        }
        
        .settings-panel {
          width: 100vw;
          right: -100vw;
          padding: 20px;
        }
        
        .category-container {
          grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
          gap: 8px;
        }
        
        .command-btn {
          padding: 12px 8px;
          min-height: 70px;
          font-size: 9px;
        }
        
        .command-icon {
          font-size: 20px;
        }
      }
      
      @media (max-width: 480px) {
        .movement-panel, .actions-panel {
          width: calc(100vw - 20px);
          left: 10px;
          right: 10px;
        }
        
        .actions-panel {
          bottom: 160px;
          max-height: 120px;
        }
        
        .actions-grid {
          grid-template-columns: repeat(3, 1fr);
        }
        
        .action-btn {
          min-height: 45px;
          padding: 6px 4px;
        }
        
        .category-container {
          grid-template-columns: repeat(3, 1fr);
        }
      }
    </style>

    <script src="md5.js"></script>
    <script src="joy.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2/dist/coco-ssd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
  </head>
  <body>
    <!-- Video Background -->
    <div class="video-background">
      <video id="video-frame" autoplay playsinline muted></video>
      <canvas id="detection-canvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 2;"></canvas>
    </div>

    <!-- UI Overlay -->
    <div class="ui-overlay">
      <!-- Top Bar -->
      <div class="top-bar">
        <div class="status-badge">
          <div class="status-dot" id="status-dot"></div>
          <span id="status-text">Disconnected</span>
        </div>
        <button class="settings-btn" id="mouseToggle" onclick="toggleMouseControl()" style="width: auto; padding: 0 16px; font-size: 12px; font-weight: 600;">Mouse: OFF</button>
        <button class="settings-btn" id="detectionToggle" onclick="toggleDetection()" style="width: auto; padding: 0 16px; font-size: 12px; font-weight: 600;">AI: OFF</button>
        <button class="settings-btn" id="visionButton" onclick="analyzeScene()" style="width: auto; padding: 0 16px; font-size: 12px; font-weight: 600;">üëÅÔ∏è Vision</button>
        <button class="settings-btn" id="settings-toggle">‚öôÔ∏è</button>
      </div>

      <!-- Movement Controls -->
      <div class="control-panel movement-panel">
        <div class="movement-grid">
          <button class="move-btn" onmousedown="startMove('turn-left')" onmouseup="stopMove()" ontouchstart="startMove('turn-left')" ontouchend="stopMove()">‚Ü∫</button>
          <button class="move-btn" onmousedown="startMove('forward')" onmouseup="stopMove()" ontouchstart="startMove('forward')" ontouchend="stopMove()">‚Üë</button>
          <button class="move-btn" onmousedown="startMove('turn-right')" onmouseup="stopMove()" ontouchstart="startMove('turn-right')" ontouchend="stopMove()">‚Üª</button>
          <button class="move-btn" onmousedown="startMove('left')" onmouseup="stopMove()" ontouchstart="startMove('left')" ontouchend="stopMove()">‚Üê</button>
          <button class="move-btn stop" onclick="stopMove()">‚èπ</button>
          <button class="move-btn" onmousedown="startMove('right')" onmouseup="stopMove()" ontouchstart="startMove('right')" ontouchend="stopMove()">‚Üí</button>
          <button class="move-btn"></button>
          <button class="move-btn" onmousedown="startMove('backward')" onmouseup="stopMove()" ontouchstart="startMove('backward')" ontouchend="stopMove()">‚Üì</button>
          <button class="move-btn"></button>
        </div>
      </div>

      <!-- Action Commands -->
      <div class="control-panel actions-panel">
        <h3 class="actions-title">Commands</h3>
        <div class="actions-grid">
          <button class="action-btn" onclick="quickCommand(1004)">
            <div class="action-icon">üêï</div>
            <div>Stand</div>
          </button>
          <button class="action-btn" onclick="quickCommand(1009)">
            <div class="action-icon">üí∫</div>
            <div>Sit</div>
          </button>
          <button class="action-btn" onclick="quickCommand(1016)">
            <div class="action-icon">üëã</div>
            <div>Hello</div>
          </button>
          <button class="action-btn" onclick="quickCommand(1022)">
            <div class="action-icon">üíÉ</div>
            <div>Dance</div>
          </button>
          <button class="action-btn" onclick="quickCommand(1017)">
            <div class="action-icon">ü§∏</div>
            <div>Stretch</div>
          </button>
          <button class="action-btn" onclick="quickCommand(1030)">
            <div class="action-icon">ü§∏‚Äç‚ôÇÔ∏è</div>
            <div>Flip</div>
          </button>

          <button class="action-btn" onclick="quickCommand(1023)">
            <div class="action-icon">üï∫</div>
            <div>Dance 2</div>
          </button>
          <button class="action-btn" onclick="quickCommand(1031)">
            <div class="action-icon">ü¶ò</div>
            <div>Jump</div>
          </button>
          <button class="action-btn" onclick="quickCommand(1036)">
            <div class="action-icon">üíñ</div>
            <div>Heart</div>
          </button>
          <button class="action-btn more-btn" onclick="toggleAllCommands()">
            <div class="action-icon">‚ãØ</div>
            <div>More</div>
          </button>
        </div>
      </div>
    </div>

    <!-- All Commands Panel -->
    <div class="all-commands-panel" id="all-commands-panel">
      <div class="commands-header">
        <h2 class="commands-title">All Commands</h2>
        <button class="close-btn" id="commands-close">‚úï</button>
      </div>
      <div class="commands-grid" id="commands-grid">
        <!-- Commands will be populated by JavaScript -->
      </div>
    </div>

    <!-- Settings Panel -->
    <div class="settings-panel" id="settings-panel">
      <div class="settings-header">
        <h2 class="settings-title">Settings</h2>
        <button class="close-btn" id="settings-close">‚úï</button>
      </div>

      <div class="form-group">
        <label class="form-label" for="robot-ip">Robot IP Address</label>
        <input type="text" id="robot-ip" class="form-input" placeholder="192.168.1.xxx">
      </div>

      <div class="form-group">
        <label class="form-label" for="token">Security Token (Optional)</label>
        <input type="text" id="token" class="form-input" placeholder="Enter security token...">
      </div>

      <div class="form-group">
        <label class="form-label" for="openai-key">OpenAI API Key (Optional)</label>
        <input type="password" id="openai-key" class="form-input" placeholder="sk-...">
        <button id="test-api-btn" class="btn" style="margin-top: 10px; background: rgba(255, 149, 0, 0.8);" onclick="testOpenAIAPI()">Test API Key</button>
      </div>

      <div class="form-group">
        <label class="form-label" for="command">Quick Commands</label>
        <select id="command" class="form-select"></select>
        <button id="execute-btn" class="btn" style="margin-top: 10px;">Execute Selected</button>
      </div>

      <div class="form-group">
        <label class="form-label" for="gamepad">Controller</label>
        <select id="gamepad" class="form-select"></select>
      </div>

      <button id="connect-btn" class="btn">Connect to Robot</button>

      <div class="form-group" style="margin-top: 20px;">
        <label class="form-label" for="custom-command">Custom Command</label>
        <div style="display: flex; gap: 10px;">
          <input type="text" id="custom-command" class="form-input" placeholder="Enter custom command..." style="flex: 1;">
          <button id="execute-custom-btn" class="btn" style="margin: 0; width: auto; padding: 16px 20px;">Send</button>
        </div>
      </div>

      <div class="log" id="log">
        <code class="log-code" id="log-code">Ready to connect...</code>
      </div>
      
      <div style="text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2); font-size: 12px; color: rgba(255,255,255,0.6);">
        Version 1.7.0 - OpenAI Vision Analysis
      </div>
    </div>

    <script>
      // Global UI functions - removed toggleSettings

      function updateConnectionStatus(connected) {
        const dot = document.getElementById('status-dot');
        const text = document.getElementById('status-text');
        
        if (connected) {
          dot.classList.add('connected');
          text.textContent = 'Connected';
        } else {
          dot.classList.remove('connected');
          text.textContent = 'Disconnected';
        }
      }

      // Mouse control state
      window.mouseControlEnabled = false;
      
      // Object detection state
      let detectionEnabled = false;
      let detectionModel = null;
      let detectionInterval = null;
      let ocrWorker = null;
      let lastEnemyAlert = 0;
      
      // OpenAI Vision state
      let isAnalyzing = false;
      
      async function loadDetectionModel() {
        try {
          logMessage('ü§ñ Loading AI detection model...');
          detectionModel = await cocoSsd.load();
          
          // Initialize OCR worker
          ocrWorker = await Tesseract.createWorker('eng');
          await ocrWorker.setParameters({
            tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789 '
          });
          
          logMessage('‚úÖ AI detection and OCR models loaded successfully');
          return true;
        } catch (error) {
          logMessage('‚ùå Failed to load AI model: ' + error.message);
          return false;
        }
      }
      
      async function toggleDetection() {
        const toggleBtn = document.getElementById('detectionToggle');
        
        if (!detectionEnabled) {
          if (!detectionModel) {
            toggleBtn.textContent = 'AI: Loading...';
            const loaded = await loadDetectionModel();
            if (!loaded) {
              toggleBtn.textContent = 'AI: Error';
              return;
            }
          }
          
          detectionEnabled = true;
          toggleBtn.textContent = 'AI: ON';
          toggleBtn.style.background = 'rgba(255, 149, 0, 0.3)';
          startDetection();
          logMessage('üëÅÔ∏è Object detection enabled');
        } else {
          detectionEnabled = false;
          toggleBtn.textContent = 'AI: OFF';
          toggleBtn.style.background = 'rgba(255,255,255,0.1)';
          stopDetection();
          logMessage('üëÅÔ∏è Object detection disabled');
        }
      }
      
      function startDetection() {
        const video = document.getElementById('video-frame');
        const canvas = document.getElementById('detection-canvas');
        const ctx = canvas.getContext('2d');
        
        detectionInterval = setInterval(async () => {
          if (!detectionEnabled || !detectionModel || !video.videoWidth) return;
          
          // Resize canvas to match video
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          
          try {
            const predictions = await detectionModel.detect(video);
            
            // Clear previous drawings
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw detections
            predictions.forEach(prediction => {
              const [x, y, width, height] = prediction.bbox;
              const score = Math.round(prediction.score * 100);
              
              // Draw bounding box
              ctx.strokeStyle = '#FF9500';
              ctx.lineWidth = 3;
              ctx.strokeRect(x, y, width, height);
              
              // Draw label background
              ctx.fillStyle = 'rgba(255, 149, 0, 0.8)';
              ctx.fillRect(x, y - 25, width, 25);
              
              // Draw label text
              ctx.fillStyle = '#000';
              ctx.font = '16px Inter';
              ctx.fillText(`${prediction.class} ${score}%`, x + 5, y - 5);
            });
            
            // Log detections
            if (predictions.length > 0) {
              const objects = predictions.map(p => `${p.class}(${Math.round(p.score*100)}%)`).join(', ');
              logMessage(`üëÅÔ∏è Detected: ${objects}`);
            }
            
            // Run OCR every 3 seconds to detect text
            const now = Date.now();
            if (now - lastEnemyAlert > 3000) {
              detectText(video);
            }
          } catch (error) {
            console.error('Detection error:', error);
          }
        }, 500); // Run detection every 500ms
      }
      
      async function detectText(video) {
        if (!ocrWorker) return;
        
        try {
          const { data: { text } } = await ocrWorker.recognize(video);
          const cleanText = text.trim();
          
          if (cleanText.length > 2) {
            lastEnemyAlert = Date.now();
            logMessage(`üìù Text detected: "${cleanText}"`);
          }
        } catch (error) {
          console.error('OCR error:', error);
        }
      }
      
      function stopDetection() {
        if (detectionInterval) {
          clearInterval(detectionInterval);
          detectionInterval = null;
        }
        
        // Clear canvas
        const canvas = document.getElementById('detection-canvas');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Terminate OCR worker
        if (ocrWorker) {
          ocrWorker.terminate();
          ocrWorker = null;
        }
      }
      
      async function analyzeScene() {
        const apiKey = document.getElementById('openai-key').value;
        if (!apiKey) {
          logMessage('‚ùå Please enter OpenAI API key in settings');
          return;
        }
        
        if (isAnalyzing) {
          logMessage('‚è≥ Analysis already in progress...');
          return;
        }
        
        const video = document.getElementById('video-frame');
        if (!video.videoWidth) {
          logMessage('‚ùå No video feed available');
          return;
        }
        
        isAnalyzing = true;
        const visionBtn = document.getElementById('visionButton');
        visionBtn.textContent = '‚è≥ Analyzing...';
        visionBtn.style.background = 'rgba(255, 149, 0, 0.3)';
        
        try {
          // Capture frame from video
          const canvas = document.createElement('canvas');
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(video, 0, 0);
          const imageData = canvas.toDataURL('image/jpeg', 0.8);
          
          logMessage('ü§ñ Analyzing scene with GPT-4 Vision...');
          
          const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
              model: 'gpt-4o',
              messages: [{
                role: 'user',
                content: [{
                  type: 'text',
                  text: 'Describe what you see in this image. Focus on objects, people, activities, and anything notable. Be concise but detailed.'
                }, {
                  type: 'image_url',
                  image_url: { 
                    url: imageData,
                    detail: 'low'
                  }
                }]
              }],
              max_tokens: 300
            })
          });
          
          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            if (response.status === 401) {
              throw new Error('Invalid API key or insufficient permissions');
            } else if (response.status === 429) {
              throw new Error('Rate limit exceeded - try again later');
            } else {
              throw new Error(`API Error ${response.status}: ${errorData.error?.message || 'Unknown error'}`);
            }
          }
          
          const data = await response.json();
          const analysis = data.choices[0].message.content;
          
          logMessage(`üëÅÔ∏è Vision Analysis: ${analysis}`);
          
          // Speak the analysis
          if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(analysis);
            utterance.rate = 0.9;
            speechSynthesis.speak(utterance);
          }
          
        } catch (error) {
          logMessage(`‚ùå Vision analysis failed: ${error.message}`);
        } finally {
          isAnalyzing = false;
          visionBtn.textContent = 'üëÅÔ∏è Vision';
          visionBtn.style.background = 'rgba(255,255,255,0.1)';
        }
      }
      
      async function testOpenAIAPI() {
        const apiKey = document.getElementById('openai-key').value;
        if (!apiKey) {
          logMessage('‚ùå Please enter OpenAI API key first');
          return;
        }
        
        const testBtn = document.getElementById('test-api-btn');
        testBtn.textContent = 'Testing...';
        testBtn.disabled = true;
        
        try {
          logMessage('üîç Testing API key...');
          
          // Test 1: Simple text completion
          logMessage('üîç Step 1: Testing basic API access...');
          const textResponse = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
              model: 'gpt-3.5-turbo',
              messages: [{ role: 'user', content: 'Say "API test successful"' }],
              max_tokens: 10
            })
          });
          
          if (!textResponse.ok) {
            const errorData = await textResponse.json().catch(() => ({}));
            throw new Error(`Text API failed (${textResponse.status}): ${errorData.error?.message || 'Unknown error'}`);
          }
          
          logMessage('‚úÖ Step 1: Basic API access works');
          
          // Test 2: Check GPT-4o availability
          logMessage('üîç Step 2: Testing GPT-4o vision access...');
          const visionResponse = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
              model: 'gpt-4o',
              messages: [{
                role: 'user',
                content: [{
                  type: 'text',
                  text: 'This is a test. Just say "Vision API works"'
                }]
              }],
              max_tokens: 10
            })
          });
          
          if (!visionResponse.ok) {
            const errorData = await visionResponse.json().catch(() => ({}));
            if (visionResponse.status === 404) {
              logMessage('‚ö†Ô∏è GPT-4o not available. Trying gpt-4-vision-preview...');
              // Fallback test
              const fallbackResponse = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                  model: 'gpt-4-vision-preview',
                  messages: [{ role: 'user', content: 'Test' }],
                  max_tokens: 5
                })
              });
              
              if (fallbackResponse.ok) {
                logMessage('‚úÖ gpt-4-vision-preview works - updating code to use this model');
                // Update the model in the main function
                return 'gpt-4-vision-preview';
              }
            }
            throw new Error(`Vision API failed (${visionResponse.status}): ${errorData.error?.message || 'Unknown error'}`);
          }
          
          logMessage('‚úÖ Step 2: GPT-4o vision access works');
          logMessage('‚úÖ API key is valid and has full access!');
          
        } catch (error) {
          logMessage(`‚ùå API Test Failed: ${error.message}`);
          logMessage('üìù Debug info:');
          logMessage(`- Key starts with: ${apiKey.substring(0, 7)}...`);
          logMessage('- Check: https://platform.openai.com/account/billing');
          logMessage('- Ensure you have credits and GPT-4 access');
        } finally {
          testBtn.textContent = 'Test API Key';
          testBtn.disabled = false;
        }
      }
      
      function quickCommand(cmdId) {
        if(globalThis.rtc !== undefined) {
          const uniqID = (new Date().valueOf() % 2147483648) + Math.floor(Math.random() * 1e3);
          globalThis.rtc.publish("rt/api/sport/request", {
            header: { identity: { id: uniqID, api_id: cmdId } },
            parameter: JSON.stringify(cmdId),
          });
          
          if (navigator.vibrate) navigator.vibrate(50);
        } else {
          logMessage("‚ùå Please connect to robot first");
        }
      }

      let moveInterval = null;
      
      function startMove(direction) {
        if (!globalThis.rtc) return;
        
        let x = 0, y = 0, z = 0;
        switch(direction) {
          case 'forward': x = 0.8; break;
          case 'backward': x = -0.4; break;
          case 'left': y = 0.4; break;
          case 'right': y = -0.4; break;
          case 'turn-left': z = 2; break;
          case 'turn-right': z = -2; break;
        }
        
        globalThis.rtc.publishApi("rt/api/sport/request", 1008, JSON.stringify({x, y, z}));
        
        moveInterval = setInterval(() => {
          if (globalThis.rtc) {
            globalThis.rtc.publishApi("rt/api/sport/request", 1008, JSON.stringify({x, y, z}));
          }
        }, 100);
      }
      
      function stopMove() {
        if (moveInterval) {
          clearInterval(moveInterval);
          moveInterval = null;
        }
        if (globalThis.rtc) {
          globalThis.rtc.publishApi("rt/api/sport/request", 1008, JSON.stringify({x: 0, y: 0, z: 0}));
        }
      }

      function toggleAllCommands() {
        const panel = document.getElementById('all-commands-panel');
        panel.classList.toggle('open');
      }
      
      function toggleMouseControl() {
        window.mouseControlEnabled = !window.mouseControlEnabled;
        const toggleBtn = document.getElementById('mouseToggle');
        toggleBtn.textContent = window.mouseControlEnabled ? 'Mouse: ON' : 'Mouse: OFF';
        toggleBtn.style.background = window.mouseControlEnabled ? 'rgba(48, 209, 88, 0.3)' : 'rgba(255,255,255,0.1)';
        
        // Add visual indicator to video area when mouse control is enabled
        const videoArea = document.querySelector('.video-background');
        if (window.mouseControlEnabled) {
          videoArea.style.border = '3px solid rgba(48, 209, 88, 0.8)';
          videoArea.style.boxShadow = 'inset 0 0 20px rgba(48, 209, 88, 0.3)';
          logMessage('üñ±Ô∏è Mouse control enabled - Use mouse on video area only');
        } else {
          videoArea.style.border = 'none';
          videoArea.style.boxShadow = 'none';
          logMessage('üñ±Ô∏è Mouse control disabled');
        }
      }
      
      // Make functions global
      window.updateConnectionStatus = updateConnectionStatus;
      window.quickCommand = quickCommand;
      window.startMove = startMove;
      window.stopMove = stopMove;
      window.toggleAllCommands = toggleAllCommands;
      window.toggleMouseControl = toggleMouseControl;
      window.toggleDetection = toggleDetection;
      window.analyzeScene = analyzeScene;
      window.testOpenAIAPI = testOpenAIAPI;
      


      // Initialize
      document.addEventListener('DOMContentLoaded', function() {
        updateConnectionStatus(false);
        
        // Settings panel toggle
        const settingsToggle = document.getElementById('settings-toggle');
        const settingsPanel = document.getElementById('settings-panel');
        const settingsClose = document.getElementById('settings-close');
        
        // All commands panel toggle
        const commandsPanel = document.getElementById('all-commands-panel');
        const commandsClose = document.getElementById('commands-close');
        
        settingsToggle.addEventListener('click', function() {
          settingsPanel.classList.add('open');
        });
        
        settingsClose.addEventListener('click', function() {
          settingsPanel.classList.remove('open');
        });
        
        commandsClose.addEventListener('click', function() {
          commandsPanel.classList.remove('open');
        });
        
        // Close when clicking outside
        document.addEventListener('click', function(e) {
          if (settingsPanel.classList.contains('open') && 
              !settingsPanel.contains(e.target) && 
              !settingsToggle.contains(e.target)) {
            settingsPanel.classList.remove('open');
          }
          
          if (commandsPanel.classList.contains('open') && 
              !commandsPanel.contains(e.target) && 
              !e.target.classList.contains('more-btn') &&
              !e.target.closest('.more-btn')) {
            commandsPanel.classList.remove('open');
          }
        });
        
        // Populate all commands
        populateAllCommands();
      });
      
      function populateAllCommands() {
        const grid = document.getElementById('commands-grid');
        const commands = {
          1001: { name: 'Damp', icon: 'üö´' },
          1002: { name: 'Balance Stand', icon: '‚öñÔ∏è' },
          1003: { name: 'Stop Move', icon: '‚èπÔ∏è' },
          1004: { name: 'Stand Up', icon: 'üêï' },
          1005: { name: 'Run Forward', icon: 'üèÉ' },
          1006: { name: 'Run Backward', icon: 'üîô' },
          1007: { name: 'Run Left', icon: '‚¨ÖÔ∏è' },
          1008: { name: 'Run Right', icon: '‚û°Ô∏è' },
          1009: { name: 'Sit Down', icon: 'üí∫' },
          1010: { name: 'Rise Sit', icon: 'üêï' },
          1011: { name: 'Switch Gait', icon: 'üîÑ' },
          1012: { name: 'Trigger', icon: 'üî´' },
          1013: { name: 'Back Flip', icon: 'ü§∏' },
          1014: { name: 'Front Flip', icon: 'ü§∏‚Äç‚ôÇÔ∏è' },
          1015: { name: 'Bow', icon: 'üôá' },
          1016: { name: 'Hello', icon: 'üëã' },
          1017: { name: 'Stretch', icon: 'ü§∏' },
          1018: { name: 'Wag Tail', icon: 'üê∂' },
          1019: { name: 'Trunk Wiggle', icon: 'üêç' },
          1020: { name: 'Butt Circle', icon: 'üîÑ' },
          1021: { name: 'Head Circle', icon: 'üîÑ' },
          1022: { name: 'Dance 1', icon: 'üíÉ' },
          1023: { name: 'Dance 2', icon: 'üï∫' },
          1024: { name: 'Space Walk', icon: 'üöÄ' },
          1025: { name: 'Chicken Head', icon: 'üêî' },
          1026: { name: 'Crab Steps', icon: 'ü¶Ä' },
          1027: { name: 'Leg Lift', icon: 'ü¶µ' },
          1028: { name: 'Shake Hands', icon: 'ü§ù' },
          1029: { name: 'Finger Heart', icon: 'ü§è' },
          1030: { name: 'Rainbow', icon: 'üåà' },
          1031: { name: 'Scrape', icon: 'üßΩ' },
          1032: { name: 'Front Somersault', icon: 'ü§∏‚Äç‚ôÄÔ∏è' },
          1033: { name: 'Right Somersault', icon: 'ü§∏' },
          1034: { name: 'Left Somersault', icon: 'ü§∏‚Äç‚ôÇÔ∏è' },
          1035: { name: 'Turn Around', icon: 'üîÑ' },
          1036: { name: 'Heart', icon: 'üíñ' }
        };
        
        const categories = {
          'Popular': {
            1004: { name: 'Stand Up', icon: 'üêï' },
            1009: { name: 'Sit Down', icon: 'üí∫' },
            1016: { name: 'Hello', icon: 'üëã' },
            1015: { name: 'Bow', icon: 'üôá' },
            1022: { name: 'Dance 1', icon: 'üíÉ' },
            1017: { name: 'Stretch', icon: 'ü§∏' }
          },
          'Dances & Fun': {
            1023: { name: 'Dance 2', icon: 'üï∫' },
            1024: { name: 'Space Walk', icon: 'üöÄ' },
            1018: { name: 'Wag Tail', icon: 'üê∂' },
            1025: { name: 'Chicken Head', icon: 'üêî' },
            1026: { name: 'Crab Steps', icon: 'ü¶Ä' },
            1036: { name: 'Heart', icon: 'üíñ' },
            1029: { name: 'Finger Heart', icon: 'ü§è' },
            1028: { name: 'Shake Hands', icon: 'ü§ù' }
          },
          'Acrobatics': {
            1013: { name: 'Back Flip', icon: 'ü§∏' },
            1014: { name: 'Front Flip', icon: 'ü§∏‚ôÇÔ∏è' },
            1032: { name: 'Front Somersault', icon: 'ü§∏‚ôÄÔ∏è' },
            1033: { name: 'Right Somersault', icon: 'ü§∏' },
            1034: { name: 'Left Somersault', icon: 'ü§∏‚ôÇÔ∏è' },
            1030: { name: 'Rainbow', icon: 'üåà' },
            1027: { name: 'Leg Lift', icon: 'ü¶µ' }
          },
          'Movement': {
            1005: { name: 'Run Forward', icon: 'üèÉ' },
            1006: { name: 'Run Backward', icon: 'üîô' },
            1007: { name: 'Run Left', icon: '‚¨ÖÔ∏è' },
            1008: { name: 'Run Right', icon: '‚û°Ô∏è' },
            1035: { name: 'Turn Around', icon: 'üîÑ' },
            1011: { name: 'Switch Gait', icon: 'üîÑ' }
          },
          'Body Moves': {
            1019: { name: 'Trunk Wiggle', icon: 'üêç' },
            1020: { name: 'Butt Circle', icon: 'üîÑ' },
            1021: { name: 'Head Circle', icon: 'üîÑ' },
            1031: { name: 'Scrape', icon: 'üßΩ' }
          },
          'Control': {
            1001: { name: 'Damp', icon: 'üö´' },
            1002: { name: 'Balance Stand', icon: '‚öñÔ∏è' },
            1003: { name: 'Stop Move', icon: '‚èπÔ∏è' },
            1010: { name: 'Rise Sit', icon: 'üêï' },
            1012: { name: 'Trigger', icon: 'üî´' }
          }
        };
        
        Object.entries(categories).forEach(([categoryName, commands]) => {
          const header = document.createElement('div');
          header.className = 'category-header';
          header.innerHTML = `<h3>${categoryName}</h3><span class="expand-icon">‚ñº</span>`;
          header.onclick = () => toggleCategory(categoryName);
          grid.appendChild(header);
          
          const container = document.createElement('div');
          container.className = 'category-container';
          container.id = `category-${categoryName}`;
          if (categoryName !== 'Popular') container.classList.add('collapsed');
          
          Object.entries(commands).forEach(([id, cmd]) => {
            const btn = document.createElement('button');
            btn.className = 'command-btn';
            btn.onclick = () => {
              quickCommand(parseInt(id));
              document.getElementById('all-commands-panel').classList.remove('open');
            };
            btn.innerHTML = `<div class="command-icon">${cmd.icon}</div><div>${cmd.name}</div>`;
            container.appendChild(btn);
          });
          
          grid.appendChild(container);
        });
      }
      
      function toggleCategory(categoryName) {
        const container = document.getElementById(`category-${categoryName}`);
        const header = container.previousElementSibling;
        const icon = header.querySelector('.expand-icon');
        
        container.classList.toggle('collapsed');
        icon.textContent = container.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
      }
    </script>
    <script type="module" src="index.js"></script>

  </body>
</html>